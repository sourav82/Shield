jobs:
  login-to-azure:
    executor: azure-cli/azure-docker
    steps:
      - checkout
      - azure-cli/login-with-service-principal
      - run: echo $BUILD_ENV
      - run:
          name: privision environment
          command: |
            ls -l
            if $NEW_ENV; then
              if [ "$BUILD_ENV" = "Dev" ]; then
                az deployment sub create --subscription $SUBSCRIPTION_ID --location eastus --template-file Infrastructure-Code/ResourceGroup/resourcegroup.json --parameters rgLocation=eastus rgName=$RESOURCE_GROUP_NAME environment=Dev project=Shield
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/VirtualNetwork/virtualnetwork.json  --parameters rgLocation=eastus environment=Dev project=Shield vnetName=VNET-DEV vnetAddressCIDR=10.100.0.0/24 functionappSubnetName=function-subnet functionappSubnetCIDR=10.100.0.0/25 apimSubnetName=apim-subnet apimSubnetCIDR=10.100.0.128/25
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/AppServicePlan/appserviceplan.json  --parameters location=eastus aspKind=linux environment=Dev project=Shield isReserved=true aspTier=PremiumV2 appServicePlanSku=P1V2 rgLocation=eastus appServicePlanName=wap-uks-dev-shield-functrak0001
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/AppService/functionapp.json  --parameters rgLocation=eastus appName=fnp-uks-dev-shield-functrak appServicePlanName=wap-uks-dev-shield-functrak0001 subnetResourceId=/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Network/virtualNetworks/VNET-DEV/subnets/function-subnet environment=Dev project=Shield webappKind=functionapp,linux numberOfFuncs=1 funcStorageName=stgshielddevfunc0001 insightName=inst-uks-dev-shield-functrak0001
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/APIManagement/apimservice.json  --parameters name=apim-uks-dev-alpha-0001 location=eastus adminEmail=sampa.koley@hotmail.com orgName=Sensyne tier=Developer capacity=1 loggerName=apimlogger appInsightsId=microsoft.insights/components/inst-uks-dev-shield-functrak0001 virtualNetworkType=External subnetId=/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Network/virtualNetworks/VNET-DEV/subnets/apim-submet environment=Dev project=Shield 
              elif [ "$BUILD_ENV" = "SIT" ]; then
                az deployment sub create --subscription $SUBSCRIPTION_ID --location eastus --template-file Infrastructure-Code/ResourceGroup/resourcegroup.json --parameters rgLocation=eastus rgName=SIT-RG environment=SIT project=Shield
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/VirtualNetwork/virtualnetwork.json --parameters rgLocation=eastus environment=SIT project=Shield vnetName=VNET-SIT vnetAddressCIDR=10.100.0.0/24 functionappSubnetName=function-subnet functionappSubnetCIDR=10.100.0.0/25 apimSubnetName=apim-subnet apimSubnetCIDR=10.100.0.128/25
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/AppServicePlan/appserviceplan.json  --parameters location=eastus aspKind=linux environment=SIT project=Shield isReserved=true aspTier=PremiumV2 appServicePlanSku=P1V2 rgLocation=eastus appServicePlanName=wap-uks-sit-shield-functrak0001
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/AppService/functionapp.json  --parameters rgLocation=eastus appName=fnp-uks-sit-shield-functrak appServicePlanName=wap-uks-sit-shield-functrak0001 subnetResourceId=/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Network/virtualNetworks/VNET-SIT/subnets/function-subnet environment=SIT project=Shield webappKind=functionapp,linux numberOfFuncs=1 funcStorageName=stgshieldsitfunc0001 insightName=inst-uks-sit-shield-functrak0001
                az deployment group create --resource-group $RESOURCE_GROUP_NAME --subscription $SUBSCRIPTION_ID --template-file Infrastructure-Code/APIManagement/apimservice.json  --parameters name=apim-uks-sit-alpha-0001 location=eastus adminEmail=sampa.koley@hotmail.com orgName=Sensyne tier=Developer capacity=1 loggerName=apimlogger appInsightsId=microsoft.insights/components/inst-uks-sit-shield-functrak0001 virtualNetworkType=External subnetId=/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP_NAME/providers/Microsoft.Network/virtualNetworks/VNET-SIT/subnets/apim-submet environment=SIT project=Shield 
              fi
            fi

orbs:
  azure-cli: circleci/azure-cli@1.0.0
version: 2.1
workflows:
  example-workflow:
    jobs:
      - login-to-azure:
          context:
            - Shield

      